<div class="min-h-screen bg-white text-gray-900" data-controller="promotion">
  <header class="border-b border-gray-200 px-4 py-3">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-2xl font-serif text-blue-700">Promotion Timeline</h1>
      <p class="text-sm text-gray-600 mt-2">Track brand promotions, discounts, and special offers</p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <%# Filters %>
    <div class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <%= form_tag promotion_path, method: :get, class: 'contents' do %>
          <div>
            <label for="country-select" class="block text-sm font-medium text-gray-700 mb-2">
              Filter by Country
            </label>
            <%= select_tag 'country_id',
                options_from_collection(@countries, :id, :name),
                prompt: 'All Countries',
                class: 'w-full border-gray-300 rounded-md px-3 py-2',
                onchange: 'this.form.submit();' %>
          </div>
        <% end %>

        <%= form_tag promotion_path, method: :get, class: 'contents' do %>
          <div>
            <label for="brand-select" class="block text-sm font-medium text-gray-700 mb-2">
              Filter by Brand
            </label>
            <%= select_tag 'brand_id',
                options_from_collection(@brands, :to_s, :to_s, :first),
                prompt: 'All Brands',
                class: 'w-full border-gray-300 rounded-md px-3 py-2',
                onchange: 'this.form.submit();' %>
          </div>
        <% end %>

        <div>
          <div class="text-sm text-gray-600">
            <p><%= @active_count %> active promotions</p>
            <p>Average discount: <span class="font-bold text-blue-700"><%= number_to_percentage(@avg_discount) %></span></p>
          </div>
        </div>
      </div>
    </div>

    <%# Active promotions timeline %>
    <div class="mb-8">
      <h2 class="text-lg font-serif mb-4 text-blue-700">Active Promotions</h2>

      <% if @discount_rankings.any? %>
        <div class="space-y-6">
          <% @discount_rankings.each do |ranking| %>
            <div class="border border-gray-200 rounded-lg p-5 hover:shadow-md transition">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h3 class="text-lg font-medium text-gray-900">
                    <%= ranking[:phone] %>
                  </h3>
                  <p class="text-sm text-gray-500">
                    <%= ranking[:channel_count] %> channels
                  </p>
                </div>
                <div class="text-right">
                  <p class="text-2xl font-bold text-green-700">
                    -<%= ranking[:max_discount] %>%
                  </p>
                </div>
              </div>

              <div class="mt-4">
                <% discounts = PromotionService.discounts_for_phone(ranking[:phone_id]) %>
                <% if discounts.any? %>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <% discounts.each do |discount| %>
                      <div class="border-l border-gray-300 rounded p-3 bg-gray-50">
                        <div class="flex justify-between items-center mb-1">
                          <span class="font-medium text-gray-900">
                            <%= discount[:channel] %>
                          </span>
                          <span class="font-bold text-green-700">
                            -<%= discount[:discount_percent] %>%
                          </span>
                        </div>
                        <div class="text-sm text-gray-600">
                          <%= number_to_currency(discount[:price]) %>
                          <% if discount[:valid_until] %>
                            <span class="ml-2 text-xs text-orange-600">
                              until <%= discount[:valid_until] %>
                            </span>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-center text-gray-500 py-8">No active promotions found</p>
      <% end %>
    </div>

    <%# Channel promotions by brand %>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <%# Telco promotions %>
      <div class="border border-gray-200 rounded-lg p-5">
        <h2 class="text-lg font-serif mb-4 text-blue-700">Telco Promotions</h2>
        <div class="space-y-3">
          <% @channels.where(channel_type: 'telco').each do |channel| %>
            <div class="border-b border-gray-200 pb-2">
              <h3 class="font-medium text-gray-900"><%= channel.name %></h3>
              <%# Show active promotions for this channel %>
              <p class="text-sm text-gray-500">
                <%= link_to 'View promotions', '#', class: 'text-blue-600 hover:text-blue-800' %>
              </p>
            </div>
          <% end %>
        </div>
      </div>

      <%# Hypermarket promotions %>
      <div class="border border-gray-200 rounded-lg p-5">
        <h2 class="text-lg font-serif mb-4 text-blue-700">Hypermarket Offers</h2>
        <div class="space-y-3">
          <% @channels.where(channel_type: 'hypermarket').each do |channel| %>
            <div class="border-b border-gray-200 pb-2">
              <h3 class="font-medium text-gray-900"><%= channel.name %></h3>
              <%# Show active promotions for this channel %>
              <p class="text-sm text-gray-500">
                <%= link_to 'View offers', '#', class: 'text-blue-600 hover:text-blue-800' %>
              </p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </main>
</div>
